<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ControlRoom.App.Views.NewThingPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:ControlRoom.App.ViewModels"
    x:DataType="vm:NewThingViewModel"
    Title="New Thing">

    <ScrollView Padding="16">
        <VerticalStackLayout Spacing="16" MaximumWidthRequest="600">
            <Label Text="Add a Local Script" FontSize="24" FontAttributes="Bold" />
            <Label Text="Point to a script file (.ps1, .py, .cmd, .bat, .sh) and give it a name" Opacity="0.7" />

            <!-- AI Script Generator Toggle -->
            <Border
                Padding="12"
                IsVisible="{Binding IsAIAvailable}"
                BackgroundColor="{AppThemeBinding Light=#F0F4FF, Dark=#1E293B}"
                StrokeShape="RoundRectangle 8"
                Stroke="#6366F1">
                <VerticalStackLayout Spacing="12">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Label Text="ðŸ¤–" FontSize="20" VerticalOptions="Center" />
                        <VerticalStackLayout Grid.Column="1" Spacing="2" Padding="8,0">
                            <Label Text="Generate with AI" FontSize="14" FontAttributes="Bold" />
                            <Label Text="Describe what you want and let AI create the script" FontSize="12" Opacity="0.7" />
                        </VerticalStackLayout>
                        <Button
                            Grid.Column="2"
                            Text="{Binding ShowAIGenerator, Converter={StaticResource BoolToExpandIcon}}"
                            FontSize="14"
                            Padding="12,6"
                            Command="{Binding ToggleAIGeneratorCommand}"
                            BackgroundColor="#6366F1"
                            TextColor="White" />
                    </Grid>

                    <!-- AI Generator Panel (collapsible) -->
                    <VerticalStackLayout Spacing="12" IsVisible="{Binding ShowAIGenerator}">
                        <!-- Language Selection -->
                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                            <Label Text="Language:" FontSize="14" VerticalOptions="Center" />
                            <Picker
                                Grid.Column="1"
                                ItemsSource="{Binding AvailableLanguages}"
                                SelectedItem="{Binding SelectedLanguage}"
                                Title="Select Language" />
                        </Grid>

                        <!-- Prompt Input -->
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Describe what you want the script to do:" FontSize="14" FontAttributes="Bold" />
                            <Editor
                                Text="{Binding AiPrompt}"
                                Placeholder="Example: A script that backs up all .docx files from Documents folder to a timestamped folder in OneDrive, with logging and error handling"
                                HeightRequest="100"
                                FontSize="13"
                                AutoSize="TextChanges" />
                        </VerticalStackLayout>

                        <!-- Generate Button -->
                        <Button
                            Text="{Binding IsGenerating, Converter={StaticResource BoolToGenerateText}}"
                            Command="{Binding GenerateScriptCommand}"
                            IsEnabled="{Binding IsGenerating, Converter={StaticResource InvertedBool}}"
                            BackgroundColor="#6366F1"
                            TextColor="White"
                            HorizontalOptions="Start"
                            Padding="16,8" />

                        <!-- Generated Script Preview -->
                        <Border
                            IsVisible="{Binding HasGeneratedScript}"
                            Padding="12"
                            BackgroundColor="#1E1E1E"
                            StrokeShape="RoundRectangle 6">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Generated Script:" FontSize="12" FontAttributes="Bold" TextColor="#E0E0E0" />
                                <Label
                                    Text="{Binding GeneratedScript}"
                                    FontFamily="Consolas"
                                    FontSize="11"
                                    TextColor="#E0E0E0"
                                    MaxLines="15"
                                    LineBreakMode="TailTruncation" />

                                <!-- Documentation -->
                                <Label
                                    Text="{Binding GeneratedDocumentation}"
                                    FontSize="11"
                                    Opacity="0.7"
                                    IsVisible="{Binding GeneratedDocumentation, Converter={StaticResource StringToBool}}" />

                                <!-- Dependencies -->
                                <VerticalStackLayout IsVisible="{Binding GeneratedDependencies.Count, Converter={StaticResource IntToBool}}">
                                    <Label Text="Dependencies:" FontSize="11" FontAttributes="Bold" />
                                    <CollectionView ItemsSource="{Binding GeneratedDependencies}" HeightRequest="40">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8" />
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="x:String">
                                                <Border Padding="6,2" BackgroundColor="#333" StrokeShape="RoundRectangle 4">
                                                    <Label Text="{Binding .}" FontSize="10" TextColor="#E0E0E0" />
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>

                                <!-- Use This Script Button -->
                                <Button
                                    Text="Use This Script"
                                    Command="{Binding SaveGeneratedScriptCommand}"
                                    BackgroundColor="#22C55E"
                                    TextColor="White"
                                    HorizontalOptions="Start"
                                    Padding="16,8" />
                            </VerticalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Name -->
            <VerticalStackLayout Spacing="4">
                <Label Text="Name" FontSize="14" FontAttributes="Bold" />
                <Entry
                    Text="{Binding Name}"
                    Placeholder="e.g. Build Project, Run Tests, Start Server" />
            </VerticalStackLayout>

            <!-- Script Path -->
            <VerticalStackLayout Spacing="4">
                <Label Text="Script Path" FontSize="14" FontAttributes="Bold" />
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Entry
                        Text="{Binding ScriptPath}"
                        Placeholder="C:\path\to\script.ps1" />
                    <Button Grid.Column="1" Text="Browse..." Command="{Binding BrowseScriptCommand}" />
                </Grid>
            </VerticalStackLayout>

            <!-- Working Directory -->
            <VerticalStackLayout Spacing="4">
                <Label Text="Working Directory (optional)" FontSize="14" FontAttributes="Bold" />
                <Entry
                    Text="{Binding WorkingDirectory}"
                    Placeholder="Defaults to script's directory" />
            </VerticalStackLayout>

            <!-- Profiles Section -->
            <Border Padding="12" StrokeShape="RoundRectangle 8" BackgroundColor="#1a1a1a">
                <VerticalStackLayout Spacing="12">
                    <!-- Profiles Header -->
                    <Grid ColumnDefinitions="*,Auto,Auto">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="Run Profiles" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                            <Label Text="{Binding Profiles.Count, StringFormat='({0})'}" Opacity="0.6" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <Button
                            Grid.Column="1"
                            Text="+ Add"
                            FontSize="12"
                            Padding="8,4"
                            Command="{Binding AddProfileCommand}"
                            BackgroundColor="#333333" />
                        <Button
                            Grid.Column="2"
                            Text="{Binding ShowProfiles, Converter={StaticResource BoolToExpandIcon}}"
                            FontSize="14"
                            Padding="8,4"
                            Command="{Binding ToggleProfilesCommand}"
                            BackgroundColor="Transparent" />
                    </Grid>

                    <Label
                        Text="Define preset argument/environment combinations (e.g., Smoke, Full, Debug)"
                        FontSize="12"
                        Opacity="0.5"
                        IsVisible="{Binding ShowProfiles, Converter={StaticResource InvertedBool}}" />

                    <!-- Profiles List (collapsible) -->
                    <VerticalStackLayout Spacing="8" IsVisible="{Binding ShowProfiles}">
                        <CollectionView ItemsSource="{Binding Profiles}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:ProfileEditorItem">
                                    <Border Padding="12" Margin="0,4" StrokeShape="RoundRectangle 6" BackgroundColor="#252525">
                                        <VerticalStackLayout Spacing="8">
                                            <!-- Profile Name + Remove -->
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Entry
                                                    Text="{Binding Name}"
                                                    Placeholder="Profile name"
                                                    FontSize="14"
                                                    FontAttributes="Bold" />
                                                <Button
                                                    Grid.Column="1"
                                                    Text="Ã—"
                                                    FontSize="16"
                                                    Padding="8,2"
                                                    BackgroundColor="Transparent"
                                                    TextColor="#FF6B6B"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:NewThingViewModel}}, Path=RemoveProfileCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Grid>

                                            <!-- Args -->
                                            <VerticalStackLayout Spacing="2">
                                                <Label Text="Arguments" FontSize="11" Opacity="0.6" />
                                                <Entry
                                                    Text="{Binding Args}"
                                                    Placeholder="--verbose --config=prod"
                                                    FontSize="13" />
                                            </VerticalStackLayout>

                                            <!-- Environment Variables -->
                                            <VerticalStackLayout Spacing="2">
                                                <Label Text="Environment (KEY=value, one per line)" FontSize="11" Opacity="0.6" />
                                                <Editor
                                                    Text="{Binding Env}"
                                                    Placeholder="DEBUG=1&#10;API_URL=https://..."
                                                    HeightRequest="60"
                                                    FontSize="12"
                                                    AutoSize="TextChanges" />
                                            </VerticalStackLayout>

                                            <!-- Working Dir Override -->
                                            <VerticalStackLayout Spacing="2">
                                                <Label Text="Working Dir Override (optional)" FontSize="11" Opacity="0.6" />
                                                <Entry
                                                    Text="{Binding WorkingDir}"
                                                    Placeholder="Leave empty to use Thing's default"
                                                    FontSize="13" />
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Error Message -->
            <Label
                Text="{Binding ErrorMessage}"
                TextColor="Red"
                IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBool}}" />

            <!-- Actions -->
            <HorizontalStackLayout Spacing="12" HorizontalOptions="End">
                <Button Text="Cancel" Command="{Binding CancelCommand}" BackgroundColor="Transparent" TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                <Button Text="Save Thing" Command="{Binding SaveCommand}" IsEnabled="{Binding CanSave}" />
            </HorizontalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
