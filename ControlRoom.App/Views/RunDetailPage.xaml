<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ControlRoom.App.Views.RunDetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:ControlRoom.App.ViewModels"
    xmlns:queries="clr-namespace:ControlRoom.Infrastructure.Storage.Queries;assembly=ControlRoom.Infrastructure"
    x:DataType="vm:RunDetailViewModel"
    Title="{Binding Header}">

    <Grid RowDefinitions="Auto,*,Auto" Padding="16">
        <!-- Header -->
        <Grid ColumnDefinitions="*,Auto">
            <VerticalStackLayout Spacing="4">
                <HorizontalStackLayout Spacing="12">
                    <Label Text="{Binding Header}" FontSize="20" FontAttributes="Bold" VerticalOptions="Center" />
                    <ActivityIndicator IsRunning="{Binding IsRunning}" IsVisible="{Binding IsRunning}" WidthRequest="20" HeightRequest="20" />
                </HorizontalStackLayout>
                <Label
                    Text="{Binding SummaryText}"
                    FontSize="14"
                    Opacity="0.7"
                    IsVisible="{Binding IsRunning, Converter={StaticResource InvertedBool}}" />
                <!-- Command line (if available) -->
                <Label
                    Text="{Binding CommandLineText}"
                    FontSize="11"
                    FontFamily="Consolas"
                    Opacity="0.5"
                    LineBreakMode="TailTruncation"
                    IsVisible="{Binding CommandLineText, Converter={StaticResource StringToBool}}" />
            </VerticalStackLayout>

            <!-- Actions -->
            <HorizontalStackLayout Grid.Column="1" Spacing="8">
                <Button
                    Text="ðŸ¤– Ask AI"
                    Command="{Binding AskAICommand}"
                    FontSize="12"
                    Padding="10,6"
                    BackgroundColor="#6366F1"
                    TextColor="White"
                    IsVisible="{Binding IsFailed}"
                    IsEnabled="{Binding IsAIAnalyzing, Converter={StaticResource InvertedBool}}" />
                <Button
                    Text="ðŸ“š Docs"
                    Command="{Binding GenerateDocsCommand}"
                    FontSize="12"
                    Padding="10,6"
                    BackgroundColor="#059669"
                    TextColor="White"
                    IsVisible="{Binding IsRunning, Converter={StaticResource InvertedBool}}"
                    IsEnabled="{Binding IsLoadingDocs, Converter={StaticResource InvertedBool}}" />
                <Button
                    Text="ðŸ“‹ Copy"
                    Command="{Binding CopySummaryCommand}"
                    FontSize="12"
                    Padding="10,6"
                    IsVisible="{Binding IsRunning, Converter={StaticResource InvertedBool}}" />
                <Button
                    Text="ðŸ“ Open Folder"
                    Command="{Binding OpenRunFolderCommand}"
                    FontSize="12"
                    Padding="10,6" />
                <Button
                    Text="ðŸ“¦ Export ZIP"
                    Command="{Binding ExportAsZipCommand}"
                    FontSize="12"
                    Padding="10,6"
                    IsVisible="{Binding IsRunning, Converter={StaticResource InvertedBool}}" />
            </HorizontalStackLayout>
        </Grid>

        <!-- Main content - split into log, AI analysis, documentation, and artifacts -->
        <Grid Grid.Row="1" Margin="0,12,0,0" RowDefinitions="*,Auto,Auto,Auto">
            <!-- Log Output -->
            <Border Padding="12" BackgroundColor="#1E1E1E" StrokeShape="RoundRectangle 8">
                <CollectionView ItemsSource="{Binding Lines}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:LogLine">
                            <HorizontalStackLayout Spacing="8" Padding="0,2">
                                <Label
                                    Text="{Binding Timestamp, StringFormat='{0:HH:mm:ss.fff}'}"
                                    FontFamily="Consolas"
                                    FontSize="11"
                                    TextColor="#666666"
                                    WidthRequest="90" />
                                <Label
                                    Text="{Binding Text}"
                                    FontFamily="Consolas"
                                    FontSize="12"
                                    TextColor="{Binding IsError, Converter={StaticResource ErrorToColor}}"
                                    LineBreakMode="TailTruncation" />
                            </HorizontalStackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Border>

            <!-- AI Analysis Panel -->
            <Border
                Grid.Row="1"
                Margin="0,12,0,0"
                Padding="16"
                IsVisible="{Binding HasAIAnalysis}"
                BackgroundColor="{AppThemeBinding Light=#F0F4FF, Dark=#1E293B}"
                StrokeShape="RoundRectangle 8"
                Stroke="#6366F1">
                <VerticalStackLayout Spacing="12">
                    <!-- Header with AI icon -->
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="ðŸ¤–" FontSize="18" VerticalOptions="Center" />
                        <Label Text="AI Analysis" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                        <Label
                            Text="{Binding AiConfidence, StringFormat='({0:P0} confidence)'}"
                            FontSize="12"
                            Opacity="0.7"
                            VerticalOptions="Center" />
                        <Border
                            Padding="6,2"
                            BackgroundColor="{Binding AiSeverity, Converter={StaticResource SeverityToColor}}"
                            StrokeShape="RoundRectangle 4"
                            Stroke="Transparent">
                            <Label Text="{Binding AiSeverity}" FontSize="11" TextColor="White" />
                        </Border>
                    </HorizontalStackLayout>

                    <!-- Summary -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Summary" FontSize="12" FontAttributes="Bold" Opacity="0.8" />
                        <Label Text="{Binding AiSummary}" FontSize="14" />
                    </VerticalStackLayout>

                    <!-- Root Cause -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Root Cause" FontSize="12" FontAttributes="Bold" Opacity="0.8" />
                        <Label Text="{Binding AiRootCause}" FontSize="14" />
                    </VerticalStackLayout>

                    <!-- Quick Fix (if available) -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding AiQuickFix, Converter={StaticResource StringToBool}}">
                        <Label Text="ðŸ’¡ Quick Fix" FontSize="12" FontAttributes="Bold" TextColor="#22C55E" />
                        <Border Padding="12" BackgroundColor="{AppThemeBinding Light=#ECFDF5, Dark=#064E3B}" StrokeShape="RoundRectangle 6">
                            <Label Text="{Binding AiQuickFix}" FontSize="13" />
                        </Border>
                    </VerticalStackLayout>

                    <!-- Suggestions -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding AISuggestions.Count, Converter={StaticResource IntToBool}}">
                        <Label Text="Suggestions" FontSize="12" FontAttributes="Bold" Opacity="0.8" />
                        <CollectionView ItemsSource="{Binding AISuggestions}" HeightRequest="100">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Label Text="{Binding .}" FontSize="13" Padding="0,2" />
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- AI Analyzing Indicator -->
            <Border
                Grid.Row="1"
                Margin="0,12,0,0"
                Padding="16"
                IsVisible="{Binding IsAIAnalyzing}"
                BackgroundColor="{AppThemeBinding Light=#F0F4FF, Dark=#1E293B}"
                StrokeShape="RoundRectangle 8"
                Stroke="#6366F1">
                <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                    <ActivityIndicator IsRunning="True" Color="#6366F1" WidthRequest="24" HeightRequest="24" />
                    <Label Text="AI is analyzing the error..." FontSize="14" VerticalOptions="Center" />
                </HorizontalStackLayout>
            </Border>

            <!-- Documentation Panel -->
            <Border
                Grid.Row="2"
                Margin="0,12,0,0"
                Padding="16"
                IsVisible="{Binding HasDocumentation}"
                BackgroundColor="{AppThemeBinding Light=#F0FDF4, Dark=#14532D}"
                StrokeShape="RoundRectangle 8"
                Stroke="#059669">
                <VerticalStackLayout Spacing="12">
                    <!-- Header -->
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="ðŸ“š" FontSize="18" VerticalOptions="Center" />
                        <Label Text="{Binding DocTitle}" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <!-- Description -->
                    <Label Text="{Binding DocDescription}" FontSize="14" />

                    <!-- Parameters -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding DocParameters.Count, Converter={StaticResource IntToBool}}">
                        <Label Text="Parameters" FontSize="12" FontAttributes="Bold" Opacity="0.8" />
                        <CollectionView ItemsSource="{Binding DocParameters}" HeightRequest="100">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:DocParameter">
                                    <Grid ColumnDefinitions="120,*" Padding="0,4">
                                        <HorizontalStackLayout Spacing="4">
                                            <Label Text="{Binding Name}" FontSize="12" FontFamily="Consolas" FontAttributes="Bold" />
                                            <Label Text="{Binding Required, Converter={StaticResource RequiredToStar}}" FontSize="12" TextColor="#EF4444" />
                                        </HorizontalStackLayout>
                                        <VerticalStackLayout Grid.Column="1" Spacing="2">
                                            <Label Text="{Binding Description}" FontSize="12" />
                                            <HorizontalStackLayout Spacing="8">
                                                <Label Text="{Binding Type, StringFormat='Type: {0}'}" FontSize="10" Opacity="0.6" />
                                                <Label
                                                    Text="{Binding DefaultValue, StringFormat='Default: {0}'}"
                                                    FontSize="10"
                                                    Opacity="0.6"
                                                    IsVisible="{Binding DefaultValue, Converter={StaticResource StringToBool}}" />
                                            </HorizontalStackLayout>
                                        </VerticalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Examples -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding DocExamples.Count, Converter={StaticResource IntToBool}}">
                        <Label Text="Examples" FontSize="12" FontAttributes="Bold" Opacity="0.8" />
                        <Border Padding="8" BackgroundColor="{AppThemeBinding Light=#E5E7EB, Dark=#1E1E1E}" StrokeShape="RoundRectangle 4">
                            <CollectionView ItemsSource="{Binding DocExamples}" HeightRequest="60">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <Label Text="{Binding .}" FontFamily="Consolas" FontSize="11" Padding="0,2" />
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Prerequisites -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding DocPrerequisites.Count, Converter={StaticResource IntToBool}}">
                        <Label Text="Prerequisites" FontSize="12" FontAttributes="Bold" Opacity="0.8" />
                        <CollectionView ItemsSource="{Binding DocPrerequisites}" HeightRequest="40">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Border Padding="8,4" BackgroundColor="#334155" StrokeShape="RoundRectangle 4">
                                        <Label Text="{Binding .}" FontSize="11" TextColor="White" />
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Notes -->
                    <Label
                        Text="{Binding DocNotes}"
                        FontSize="12"
                        FontAttributes="Italic"
                        Opacity="0.7"
                        IsVisible="{Binding DocNotes, Converter={StaticResource StringToBool}}" />
                </VerticalStackLayout>
            </Border>

            <!-- Documentation Loading Indicator -->
            <Border
                Grid.Row="2"
                Margin="0,12,0,0"
                Padding="16"
                IsVisible="{Binding IsLoadingDocs}"
                BackgroundColor="{AppThemeBinding Light=#F0FDF4, Dark=#14532D}"
                StrokeShape="RoundRectangle 8"
                Stroke="#059669">
                <HorizontalStackLayout Spacing="12" HorizontalOptions="Center">
                    <ActivityIndicator IsRunning="True" Color="#059669" WidthRequest="24" HeightRequest="24" />
                    <Label Text="Generating documentation..." FontSize="14" VerticalOptions="Center" />
                </HorizontalStackLayout>
            </Border>

            <!-- Artifacts Panel -->
            <Border
                Grid.Row="3"
                Margin="0,12,0,0"
                Padding="12"
                IsVisible="{Binding HasArtifacts}"
                StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Artifacts" FontSize="14" FontAttributes="Bold" />
                    <CollectionView ItemsSource="{Binding Artifacts}" HeightRequest="120">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="queries:ArtifactListItem">
                                <Border
                                    Padding="12"
                                    WidthRequest="180"
                                    StrokeShape="RoundRectangle 6"
                                    BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RunDetailViewModel}}, Path=OpenArtifactCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="{Binding FileName}" FontSize="13" FontAttributes="Bold" LineBreakMode="TailTruncation" />
                                        <Label Text="{Binding MediaType}" FontSize="11" Opacity="0.6" />
                                        <Label Text="{Binding FileSizeBytes, StringFormat='{0:N0} bytes'}" FontSize="11" Opacity="0.6" />
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
