<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ControlRoom.App.Views.RunbookDesignerPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:ControlRoom.App.ViewModels"
    x:DataType="vm:RunbookDesignerViewModel"
    Title="{Binding PageTitle}">

    <ScrollView Padding="16">
        <VerticalStackLayout Spacing="16">
            <!-- Basic Info -->
            <Border Padding="16" StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="12">
                    <Label Text="Runbook Details" FontSize="18" FontAttributes="Bold" />

                    <VerticalStackLayout Spacing="4">
                        <Label Text="Name *" FontSize="12" Opacity="0.7" />
                        <Entry Text="{Binding Name}" Placeholder="e.g., Deploy Pipeline" />
                    </VerticalStackLayout>

                    <VerticalStackLayout Spacing="4">
                        <Label Text="Description" FontSize="12" Opacity="0.7" />
                        <Editor Text="{Binding Description}" Placeholder="What does this runbook do?" HeightRequest="60" />
                    </VerticalStackLayout>

                    <HorizontalStackLayout Spacing="8">
                        <Switch IsToggled="{Binding IsEnabled}" />
                        <Label Text="Enabled" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Trigger Configuration -->
            <Border Padding="16" StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="12">
                    <Label Text="Trigger" FontSize="18" FontAttributes="Bold" />
                    <Label Text="How should this runbook start?" FontSize="12" Opacity="0.7" />

                    <Picker
                        Title="Trigger Type"
                        ItemsSource="{Binding TriggerTypes}"
                        SelectedItem="{Binding SelectedTriggerType}" />

                    <!-- Schedule Options -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding ShowScheduleOptions}">
                        <Label Text="Cron Expression" FontSize="12" Opacity="0.7" />
                        <Entry Text="{Binding CronExpression}" Placeholder="0 2 * * *" />
                        <Label Text="e.g., '0 2 * * *' = 2 AM daily" FontSize="11" Opacity="0.5" />
                    </VerticalStackLayout>

                    <!-- Webhook Options -->
                    <VerticalStackLayout Spacing="4" IsVisible="{Binding ShowWebhookOptions}">
                        <Label Text="Webhook Secret" FontSize="12" Opacity="0.7" />
                        <Grid ColumnDefinitions="*,Auto">
                            <Entry Text="{Binding WebhookSecret}" Placeholder="Auto-generated" />
                            <Button Grid.Column="1" Text="Generate" Command="{Binding GenerateWebhookSecretCommand}" Padding="8,4" />
                        </Grid>
                    </VerticalStackLayout>

                    <!-- File Watch Options -->
                    <VerticalStackLayout Spacing="8" IsVisible="{Binding ShowFileWatchOptions}">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Watch Path" FontSize="12" Opacity="0.7" />
                            <Entry Text="{Binding WatchPath}" Placeholder="C:\Data\incoming" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Spacing="4">
                            <Label Text="File Pattern" FontSize="12" Opacity="0.7" />
                            <Entry Text="{Binding WatchPattern}" Placeholder="*.csv" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Steps -->
            <Border Padding="16" StrokeShape="RoundRectangle 8">
                <VerticalStackLayout Spacing="12">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="Steps" FontSize="18" FontAttributes="Bold" />
                        <Button Grid.Column="1" Text="+ Add Step" Command="{Binding AddStepCommand}" BackgroundColor="#2196F3" TextColor="White" />
                    </Grid>

                    <Label Text="Drag steps to reorder. Steps run in parallel unless dependencies are set." FontSize="12" Opacity="0.7" />

                    <!-- Steps List -->
                    <CollectionView ItemsSource="{Binding Steps}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="vm:StepDesignerItem">
                                <Border Padding="12" Margin="0,4" StrokeShape="RoundRectangle 8"
                                        BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}">
                                    <VerticalStackLayout Spacing="8">
                                        <!-- Step Header -->
                                        <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                                            <!-- Step Number -->
                                            <Label Text="#" FontSize="14" FontAttributes="Bold" VerticalOptions="Center" Margin="0,0,8,0" />

                                            <!-- Step Name -->
                                            <Entry Grid.Column="1" Text="{Binding Name}" FontSize="14" FontAttributes="Bold" />

                                            <!-- Move Buttons -->
                                            <Button Grid.Column="2" Text="^" Padding="4" FontSize="12"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RunbookDesignerViewModel}}, Path=MoveStepUpCommand}"
                                                    CommandParameter="{Binding .}" />
                                            <Button Grid.Column="3" Text="v" Padding="4" FontSize="12"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RunbookDesignerViewModel}}, Path=MoveStepDownCommand}"
                                                    CommandParameter="{Binding .}" />

                                            <!-- Delete Button -->
                                            <Button Grid.Column="4" Text="X" Padding="4" FontSize="12" TextColor="Red"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:RunbookDesignerViewModel}}, Path=RemoveStepCommand}"
                                                    CommandParameter="{Binding .}" />
                                        </Grid>

                                        <!-- Script Selection -->
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Picker
                                                Title="Select Script"
                                                ItemsSource="{Binding AvailableThings}"
                                                SelectedItem="{Binding SelectedThing}"
                                                ItemDisplayBinding="{Binding Name}" />
                                            <Entry Grid.Column="1" Text="{Binding SelectedProfile}" Placeholder="Profile" WidthRequest="100" />
                                        </Grid>

                                        <!-- Expand/Collapse -->
                                        <Button Text="{Binding IsExpanded, Converter={StaticResource BoolToExpandIcon}}"
                                                Command="{Binding ToggleExpandedCommand}"
                                                HorizontalOptions="Start" Padding="0" BackgroundColor="Transparent"
                                                TextColor="{AppThemeBinding Light=Gray, Dark=#888}" />

                                        <!-- Expanded Options -->
                                        <VerticalStackLayout Spacing="8" IsVisible="{Binding IsExpanded}">
                                            <!-- Condition -->
                                            <Grid ColumnDefinitions="*,*">
                                                <VerticalStackLayout Spacing="4">
                                                    <Label Text="Run Condition" FontSize="12" Opacity="0.7" />
                                                    <Picker ItemsSource="{Binding ConditionOptions}" SelectedItem="{Binding SelectedCondition}" />
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Grid.Column="1" Spacing="4" IsVisible="{Binding ShowExpressionInput}">
                                                    <Label Text="Expression" FontSize="12" Opacity="0.7" />
                                                    <Entry Text="{Binding ConditionExpression}" Placeholder="step1.succeeded AND step2.failed" />
                                                </VerticalStackLayout>
                                            </Grid>

                                            <!-- Dependencies -->
                                            <VerticalStackLayout Spacing="4">
                                                <Label Text="Depends On (runs after these steps complete)" FontSize="12" Opacity="0.7" />
                                                <FlexLayout Wrap="Wrap" JustifyContent="Start">
                                                    <CollectionView ItemsSource="{Binding AvailableDependencies}" SelectionMode="Multiple">
                                                        <CollectionView.ItemsLayout>
                                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="4" />
                                                        </CollectionView.ItemsLayout>
                                                        <CollectionView.ItemTemplate>
                                                            <DataTemplate x:DataType="x:String">
                                                                <Border Padding="8,4" StrokeShape="RoundRectangle 4">
                                                                    <Label Text="{Binding .}" FontSize="12" />
                                                                </Border>
                                                            </DataTemplate>
                                                        </CollectionView.ItemTemplate>
                                                    </CollectionView>
                                                </FlexLayout>
                                            </VerticalStackLayout>

                                            <!-- Arguments Override -->
                                            <VerticalStackLayout Spacing="4">
                                                <Label Text="Arguments Override (optional)" FontSize="12" Opacity="0.7" />
                                                <Entry Text="{Binding ArgumentsOverride}" Placeholder="--flag value" />
                                            </VerticalStackLayout>

                                            <!-- Timeout -->
                                            <Grid ColumnDefinitions="*,*">
                                                <VerticalStackLayout Spacing="4">
                                                    <Label Text="Timeout (seconds, 0 = no limit)" FontSize="12" Opacity="0.7" />
                                                    <Entry Text="{Binding TimeoutSeconds}" Keyboard="Numeric" />
                                                </VerticalStackLayout>
                                            </Grid>

                                            <!-- Retry Policy -->
                                            <HorizontalStackLayout Spacing="8">
                                                <Switch IsToggled="{Binding EnableRetry}" />
                                                <Label Text="Enable Retry on Failure" VerticalOptions="Center" />
                                            </HorizontalStackLayout>

                                            <Grid ColumnDefinitions="*,*" IsVisible="{Binding EnableRetry}">
                                                <VerticalStackLayout Spacing="4">
                                                    <Label Text="Max Retries" FontSize="12" Opacity="0.7" />
                                                    <Entry Text="{Binding MaxRetries}" Keyboard="Numeric" />
                                                </VerticalStackLayout>
                                                <VerticalStackLayout Grid.Column="1" Spacing="4">
                                                    <Label Text="Initial Delay (sec)" FontSize="12" Opacity="0.7" />
                                                    <Entry Text="{Binding RetryDelaySeconds}" Keyboard="Numeric" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Empty State -->
                    <Label
                        Text="No steps yet. Click '+ Add Step' to start building your workflow."
                        IsVisible="{Binding Steps.Count, Converter={StaticResource IntToBoolInverter}}"
                        Opacity="0.6"
                        HorizontalOptions="Center" />
                </VerticalStackLayout>
            </Border>

            <!-- Validation Errors -->
            <Border Padding="12" StrokeShape="RoundRectangle 8"
                    BackgroundColor="#FFEBEE"
                    IsVisible="{Binding HasValidationErrors}">
                <VerticalStackLayout Spacing="4">
                    <Label Text="Validation Issues:" FontSize="12" FontAttributes="Bold" TextColor="#C62828" />
                    <Label Text="{Binding ValidationErrorsText}" FontSize="12" TextColor="#C62828" />
                </VerticalStackLayout>
            </Border>

            <!-- Error Message -->
            <Label Text="{Binding ErrorMessage}" TextColor="Red" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBool}}" />

            <!-- Action Buttons -->
            <HorizontalStackLayout Spacing="12" HorizontalOptions="End">
                <Button Text="Cancel" Command="{Binding CancelCommand}" />
                <Button Text="Save Runbook" Command="{Binding SaveCommand}" IsEnabled="{Binding CanSave}"
                        BackgroundColor="#4CAF50" TextColor="White" />
            </HorizontalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
